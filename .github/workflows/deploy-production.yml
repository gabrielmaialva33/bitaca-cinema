name: Deploy to Production VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  SERVER_HOST: 162.12.204.30
  SERVER_USER: root
  DEPLOY_BASE: /opt/bitaca-cinema

jobs:
  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: npm install -D @playwright/test

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E smoke tests
        env:
          TEST_ENV: production
        run: |
          echo "ðŸ§ª Running smoke tests against production..."
          npx playwright test tests/e2e/smoke.spec.js --project="Desktop Chrome" --reporter=list

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            test-results/
            tests/report/
          retention-days: 7

  deploy:
    name: Deploy ${{ matrix.app }}
    runs-on: ubuntu-latest
    needs: test-e2e

    strategy:
      matrix:
        app:
          - backend
          - play
          - chat
          - play-3d
          - bet
        include:
          - app: backend
            source: apps/backend
            target: /opt/bitaca-cinema/backend
            service: docker
          - app: play
            source: apps/play
            target: /opt/bitaca-cinema/apps/play
            service: nginx
          - app: chat
            source: apps/chat
            target: /opt/bitaca-cinema/apps/chat
            service: nginx
          - app: play-3d
            source: apps/play-3d
            target: /opt/bitaca-cinema/apps/play-3d
            service: nginx
          - app: bet
            source: apps/bet
            target: /opt/bitaca-cinema/apps/bet
            service: nginx
            needs_build: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Setup Node.js (for bet app build)
        if: matrix.app == 'bet'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build bet app
        if: matrix.app == 'bet'
        run: |
          cd ${{ matrix.source }}
          npm install
          npm run build
          echo "âœ… Bet app built successfully"

      - name: Deploy ${{ matrix.app }}
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'EOF'

          echo "ðŸš€ Deploying ${{ matrix.app }}..."

          # Create target directory if doesn't exist
          mkdir -p ${{ matrix.target }}

          EOF

      - name: Sync files
        run: |
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            ${{ matrix.source }}/ \
            ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ matrix.target }}/

      - name: Restart backend service
        if: matrix.app == 'backend'
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'EOF'
          cd /root/bitaca-cinema

          # Copy backend files to root for Docker
          cp -f apps/backend/*.py .
          cp -rf apps/backend/agents .
          cp -f apps/backend/requirements.txt .
          cp -f apps/frontend/assets/data/embeddings.json .

          # Restart Docker containers
          docker compose down
          docker compose build --no-cache api
          docker compose up -d api

          echo "âœ… Backend restarted"
          EOF

      - name: Reload nginx
        if: matrix.service == 'nginx'
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'EOF'

          # Test nginx config
          sudo nginx -t

          # Reload nginx
          sudo systemctl reload nginx

          echo "âœ… Nginx reloaded"
          EOF

      - name: Verify ${{ matrix.app }} deployment
        run: |
          echo "âœ… ${{ matrix.app }} deployed successfully"

  verify:
    name: Verify Deployment
    needs: deploy
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Check services
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'EOF'

          echo "ðŸ“Š Service Status:"

          # Check Docker
          echo "Backend API:"
          docker compose ps

          # Check Nginx
          echo "Nginx:"
          sudo systemctl status nginx --no-pager | head -5

          EOF

      - name: Test endpoints
        run: |
          echo "ðŸ§ª Testing endpoints..."

          # Test API
          if curl -f https://api.abitaca.com.br/health; then
            echo "âœ… API OK"
          else
            echo "âŒ API failed"
          fi

          # Test Play
          if curl -f -I https://play.abitaca.com.br; then
            echo "âœ… Play OK"
          else
            echo "âŒ Play failed"
          fi

          # Test Chat
          if curl -f -I https://chat.abitaca.com.br; then
            echo "âœ… Chat OK"
          else
            echo "âŒ Chat failed"
          fi

          # Test Play 3D
          if curl -f -I https://play3d.abitaca.com.br; then
            echo "âœ… Play 3D OK"
          else
            echo "âŒ Play 3D failed"
          fi

      - name: Purge Cloudflare cache
        if: success()
        run: |
          echo "ðŸ§¹ Purging Cloudflare cache..."

          curl -X POST "https://api.cloudflare.com/client/v4/zones/523a4a3adef5549c21bc1dfcc0834c09/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}' \
            -s | grep -q '"success":true' && echo "âœ… Cache purged" || echo "âš ï¸ Cache purge failed"

  notify:
    name: Deployment Summary
    needs: verify
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Show results
        run: |
          echo "ðŸŽ‰ Deployment Complete!"
          echo ""
          echo "ðŸ“ Endpoints:"
          echo "  API:      https://api.abitaca.com.br"
          echo "  Play:     https://play.abitaca.com.br"
          echo "  Chat:     https://chat.abitaca.com.br"
          echo "  Play 3D:  https://play3d.abitaca.com.br"
          echo "  Frontend: https://www.abitaca.com.br"
