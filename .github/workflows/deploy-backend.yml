name: Deploy to cinewinx (Backend + Frontend)

on:
  push:
    branches:
      - main
    paths:
      - 'apps/backend/**'
      - 'apps/frontend/**'
  workflow_dispatch: # Permite executar manualmente

env:
  SERVER_HOST: 162.12.204.30
  SERVER_USER: root
  DEPLOY_DIR: /root/bitaca-cinema
  DOMAIN: api.abitaca.com.br

jobs:
  deploy:
    name: Deploy Backend to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Pull latest code and prepare files
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'EOF'
          cd ${{ env.DEPLOY_DIR }}

          # Pull latest code from git
          echo "ðŸ“¥ Pulling latest code..."
          git pull origin main

          # Copy backend files from apps/backend to root (for Docker compatibility)
          echo "ðŸ“ Preparing backend files..."
          cp -f apps/backend/*.py .
          cp -rf apps/backend/agents .
          cp -f apps/backend/requirements.txt .

          # Copy embeddings.json from frontend to root
          cp -f apps/frontend/assets/data/embeddings.json .

          # Frontend via GitHub Pages proxy (no files to copy)
          echo "ðŸ“ Frontend proxied from GitHub Pages - no files to copy"
          # www.abitaca.com.br proxies to https://gabrielmaialva33.github.io/bitaca-cinema/
          # This saves VPS resources and auto-updates with GitHub Pages deployments!

          # Update nginx configs on system
          echo "ðŸ”§ Updating nginx configs..."
          if [ -d "nginx-server-configs" ]; then
            sudo cp -f nginx-server-configs/bitaca-api.conf /etc/nginx/sites-available/
            sudo cp -f nginx-server-configs/bitaca-www.conf /etc/nginx/sites-available/

            # Enable sites if not already enabled
            [ ! -L /etc/nginx/sites-enabled/bitaca-api.conf ] && sudo ln -sf /etc/nginx/sites-available/bitaca-api.conf /etc/nginx/sites-enabled/
            [ ! -L /etc/nginx/sites-enabled/bitaca-www.conf ] && sudo ln -sf /etc/nginx/sites-available/bitaca-www.conf /etc/nginx/sites-enabled/

            # Test nginx configuration
            sudo nginx -t
          fi

          # Create log directories
          mkdir -p logs

          echo "âœ… Files prepared for deployment"
          EOF

      - name: Configure environment
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'EOF'
          cd ${{ env.DEPLOY_DIR }}

          # Create .env if doesn't exist
          if [ ! -f .env ]; then
            cp .env.example .env
            echo "NVIDIA_API_KEY=${{ secrets.NVIDIA_API_KEY }}" >> .env
            echo "ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}" >> .env
          fi
          EOF

      - name: Build and deploy containers
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'EOF'
          cd ${{ env.DEPLOY_DIR }}

          echo "ðŸ³ Starting API deployment..."

          # Stop existing containers
          docker compose down

          # Build with no cache for fresh build (only API)
          echo "ðŸ”¨ Building API container..."
          docker compose build --no-cache api

          # Start API container
          echo "ðŸš€ Starting API container..."
          docker compose up -d api

          # Reload nginx configuration
          echo "ðŸ”§ Reloading nginx..."
          sudo systemctl reload nginx

          # Wait for API to be healthy
          echo "â³ Waiting for API to be ready..."
          sleep 15

          # Show status
          echo "ðŸ“Š Service status:"
          docker compose ps
          sudo systemctl status nginx --no-pager | head -10
          EOF

      - name: Verify deployment
        run: |
          # Wait a bit more for services to fully start
          sleep 10

          # Check health endpoint
          for i in {1..5}; do
            if curl -f http://${{ env.DOMAIN }}/health; then
              echo "âœ… API is healthy!"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done

          echo "âŒ Health check failed after 5 attempts"

          # Show logs for debugging
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "cd ${{ env.DEPLOY_DIR }} && docker compose logs --tail=50"
          exit 1

      - name: Purge Cloudflare cache
        if: success()
        run: |
          echo "ðŸ§¹ Purging Cloudflare cache..."

          # Purge all cache
          PURGE_RESULT=$(curl -X POST "https://api.cloudflare.com/client/v4/zones/523a4a3adef5549c21bc1dfcc0834c09/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}' \
            -s)

          if echo "$PURGE_RESULT" | grep -q '"success":true'; then
            echo "âœ… Cloudflare cache purged successfully!"
          else
            echo "âš ï¸  Cache purge failed: $PURGE_RESULT"
          fi

          # Set cache level to bypass
          CACHE_RESULT=$(curl -X PATCH "https://api.cloudflare.com/client/v4/zones/523a4a3adef5549c21bc1dfcc0834c09/settings/cache_level" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"value":"bypass"}' \
            -s)

          if echo "$CACHE_RESULT" | grep -q '"success":true'; then
            echo "âœ… Cache level set to bypass"
          else
            echo "âš ï¸  Cache level update failed: $CACHE_RESULT"
          fi

      - name: Show deployment info
        if: success()
        run: |
          echo "ðŸŽ‰ Deployment successful!"
          echo "API URL: https://${{ env.DOMAIN }}"
          echo "Health: https://${{ env.DOMAIN }}/health"
          echo "Docs: https://${{ env.DOMAIN }}/docs"
          echo "Frontend: https://www.abitaca.com.br"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Check logs with: ssh root@${{ env.SERVER_HOST }} 'cd ${{ env.DEPLOY_DIR }} && docker compose logs'"
