<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream API Test - Bitaca Cinema</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0A0A0A;
            color: #00FF00;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #C41E3A;
            margin-bottom: 20px;
            font-size: 24px;
        }

        h2 {
            color: #FF6B6B;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #999;
        }

        input {
            width: 100%;
            padding: 10px;
            background: #1A1A1A;
            border: 1px solid #333;
            color: #00FF00;
            font-family: 'Courier New', monospace;
            border-radius: 4px;
        }

        button {
            background: #C41E3A;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background: #8B1528;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .log {
            background: #000;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-size: 12px;
            margin-top: 15px;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #1A1A1A;
        }

        .log-time {
            color: #666;
            margin-right: 10px;
        }

        .log-success { color: #00FF00; }
        .log-error { color: #FF3333; }
        .log-info { color: #3399FF; }
        .log-warning { color: #FFAA00; }

        video {
            width: 100%;
            max-width: 800px;
            border: 2px solid #C41E3A;
            border-radius: 8px;
            margin-top: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(196, 30, 58, 0.1);
            border: 1px solid #C41E3A;
            border-radius: 6px;
            padding: 15px;
        }

        .stat-label {
            color: #999;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #00FF00;
            font-size: 20px;
            font-weight: bold;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }

        .status-ok { background: rgba(0, 255, 0, 0.2); color: #00FF00; }
        .status-error { background: rgba(255, 51, 51, 0.2); color: #FF3333; }
        .status-pending { background: rgba(255, 170, 0, 0.2); color: #FFAA00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ Bitaca Stream API Test Tool</h1>

        <!-- Configuration -->
        <div class="section">
            <h2>‚öôÔ∏è Configuration</h2>
            <div class="input-group">
                <label>Stream API Base URL:</label>
                <input type="text" id="api-base-url" value="https://stream-api.abitaca.com.br/api/v1">
            </div>
            <div class="input-group">
                <label>Message ID (Telegram):</label>
                <input type="text" id="message-id" placeholder="Enter message ID" value="1">
            </div>
            <button onclick="testConnection()">üîå Test Connection</button>
            <button onclick="testHeaders()">üìã Check Headers</button>
            <button onclick="testRangeRequest()">üì¶ Test Range Request</button>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <!-- Video Test -->
        <div class="section">
            <h2>üé• Video Stream Test</h2>
            <button onclick="loadVideo()">‚ñ∂Ô∏è Load Video</button>
            <button onclick="playVideo()">‚èØÔ∏è Play</button>
            <button onclick="pauseVideo()">‚è∏Ô∏è Pause</button>
            <button onclick="stopVideo()">‚èπÔ∏è Stop</button>

            <video id="test-video" controls crossorigin="anonymous"></video>

            <!-- Stats -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Status</div>
                    <div class="stat-value" id="stat-status">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ready State</div>
                    <div class="stat-value" id="stat-ready">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Current Time</div>
                    <div class="stat-value" id="stat-time">0:00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Duration</div>
                    <div class="stat-value" id="stat-duration">0:00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Buffered</div>
                    <div class="stat-value" id="stat-buffered">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Network State</div>
                    <div class="stat-value" id="stat-network">-</div>
                </div>
            </div>
        </div>

        <!-- CORS Test -->
        <div class="section">
            <h2>üåê CORS & Headers Test</h2>
            <button onclick="testCORS()">üîí Test CORS</button>
            <button onclick="testContentType()">üìÑ Test Content-Type</button>
            <button onclick="testAcceptRanges()">üìä Test Accept-Ranges</button>
            <div id="cors-result"></div>
        </div>

        <!-- Console Log -->
        <div class="section">
            <h2>üìù Console Log</h2>
            <div class="log" id="console-log"></div>
        </div>
    </div>

    <script>
        // Global state
        let video = null;
        let statsInterval = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            video = document.getElementById('test-video');
            setupVideoListeners();
            log('Test tool initialized', 'info');
        });

        // Logging
        function log(message, type = 'info') {
            const logDiv = document.getElementById('console-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;

            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="log-time">[${time}]</span>${message}`;

            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('console-log').innerHTML = '';
            log('Log cleared', 'info');
        }

        // Get stream URL
        function getStreamURL() {
            const baseURL = document.getElementById('api-base-url').value;
            const messageId = document.getElementById('message-id').value;
            return `${baseURL}/posts/${messageId}/video`;
        }

        // Test connection
        async function testConnection() {
            log('Testing connection...', 'info');
            const url = getStreamURL();

            try {
                const response = await fetch(url, {
                    method: 'HEAD',
                    mode: 'cors'
                });

                if (response.ok) {
                    log(`‚úÖ Connection successful! Status: ${response.status}`, 'success');
                    log(`Content-Type: ${response.headers.get('content-type')}`, 'info');
                    log(`Content-Length: ${response.headers.get('content-length')} bytes`, 'info');
                } else {
                    log(`‚ùå Connection failed! Status: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Connection error: ${error.message}`, 'error');
            }
        }

        // Test headers
        async function testHeaders() {
            log('Checking response headers...', 'info');
            const url = getStreamURL();

            try {
                const response = await fetch(url, {
                    method: 'HEAD',
                    mode: 'cors'
                });

                const headers = {};
                response.headers.forEach((value, key) => {
                    headers[key] = value;
                });

                log('Response Headers:', 'info');
                Object.entries(headers).forEach(([key, value]) => {
                    log(`  ${key}: ${value}`, 'info');
                });

                // Check critical headers
                if (!headers['accept-ranges']) {
                    log('‚ö†Ô∏è Missing Accept-Ranges header (required for seeking)', 'warning');
                }

                if (!headers['content-type']?.includes('video')) {
                    log('‚ö†Ô∏è Content-Type is not video/*', 'warning');
                }

            } catch (error) {
                log(`‚ùå Headers error: ${error.message}`, 'error');
            }
        }

        // Test range request
        async function testRangeRequest() {
            log('Testing range request...', 'info');
            const url = getStreamURL();

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Range': 'bytes=0-1023'
                    }
                });

                if (response.status === 206) {
                    log('‚úÖ Range request successful! Server supports partial content', 'success');
                    log(`Content-Range: ${response.headers.get('content-range')}`, 'info');
                } else if (response.status === 200) {
                    log('‚ö†Ô∏è Server returned full content (200) instead of partial (206)', 'warning');
                } else {
                    log(`‚ùå Range request failed! Status: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Range request error: ${error.message}`, 'error');
            }
        }

        // Load video
        function loadVideo() {
            const url = getStreamURL();
            log(`Loading video from: ${url}`, 'info');

            video.src = url;
            video.load();

            // Start stats monitoring
            if (statsInterval) clearInterval(statsInterval);
            statsInterval = setInterval(updateStats, 500);
        }

        // Play video
        function playVideo() {
            if (!video.src) {
                log('‚ö†Ô∏è No video loaded. Click "Load Video" first.', 'warning');
                return;
            }

            video.play()
                .then(() => log('‚ñ∂Ô∏è Video playing', 'success'))
                .catch(error => log(`‚ùå Play error: ${error.message}`, 'error'));
        }

        // Pause video
        function pauseVideo() {
            video.pause();
            log('‚è∏Ô∏è Video paused', 'info');
        }

        // Stop video
        function stopVideo() {
            video.pause();
            video.currentTime = 0;
            log('‚èπÔ∏è Video stopped', 'info');
        }

        // Setup video event listeners
        function setupVideoListeners() {
            video.addEventListener('loadstart', () => log('üì• Loading started', 'info'));
            video.addEventListener('loadedmetadata', () => log('üìã Metadata loaded', 'success'));
            video.addEventListener('loadeddata', () => log('üìä Data loaded', 'success'));
            video.addEventListener('canplay', () => log('‚úÖ Can play', 'success'));
            video.addEventListener('canplaythrough', () => log('‚úÖ Can play through', 'success'));
            video.addEventListener('playing', () => log('‚ñ∂Ô∏è Playing', 'success'));
            video.addEventListener('pause', () => log('‚è∏Ô∏è Paused', 'info'));
            video.addEventListener('ended', () => log('‚èπÔ∏è Ended', 'info'));
            video.addEventListener('error', (e) => {
                const error = video.error;
                log(`‚ùå Video error (code ${error.code}): ${error.message}`, 'error');
            });
            video.addEventListener('stalled', () => log('‚ö†Ô∏è Stalled', 'warning'));
            video.addEventListener('waiting', () => log('‚è≥ Waiting for data', 'warning'));
            video.addEventListener('progress', () => log('üì• Downloading...', 'info'));
        }

        // Update stats
        function updateStats() {
            if (!video.src) return;

            // Status
            const statusMap = ['Empty', 'Idle', 'Loading', 'No Source', 'Error'];
            document.getElementById('stat-status').textContent =
                video.paused ? 'Paused' : 'Playing';

            // Ready state
            const readyStateMap = ['Nothing', 'Metadata', 'Current', 'Future', 'Enough'];
            document.getElementById('stat-ready').textContent =
                readyStateMap[video.readyState] || 'Unknown';

            // Time
            document.getElementById('stat-time').textContent = formatTime(video.currentTime);
            document.getElementById('stat-duration').textContent = formatTime(video.duration);

            // Buffered
            if (video.buffered.length > 0) {
                const buffered = video.buffered.end(video.buffered.length - 1);
                const percent = (buffered / video.duration * 100).toFixed(0);
                document.getElementById('stat-buffered').textContent = `${percent}%`;
            }

            // Network state
            const networkStateMap = ['Empty', 'Idle', 'Loading', 'No Source'];
            document.getElementById('stat-network').textContent =
                networkStateMap[video.networkState] || 'Unknown';
        }

        // Format time
        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Test CORS
        async function testCORS() {
            log('Testing CORS configuration...', 'info');
            const url = getStreamURL();

            try {
                const response = await fetch(url, {
                    method: 'OPTIONS',
                    mode: 'cors'
                });

                const allowOrigin = response.headers.get('access-control-allow-origin');
                const allowMethods = response.headers.get('access-control-allow-methods');
                const allowHeaders = response.headers.get('access-control-allow-headers');

                if (allowOrigin) {
                    log(`‚úÖ CORS enabled. Origin: ${allowOrigin}`, 'success');
                } else {
                    log('‚ùå CORS not configured!', 'error');
                }

                if (allowMethods) {
                    log(`Methods: ${allowMethods}`, 'info');
                }

                if (allowHeaders) {
                    log(`Headers: ${allowHeaders}`, 'info');
                }

            } catch (error) {
                log(`‚ùå CORS test error: ${error.message}`, 'error');
            }
        }

        // Test content type
        async function testContentType() {
            log('Checking content type...', 'info');
            const url = getStreamURL();

            try {
                const response = await fetch(url, { method: 'HEAD' });
                const contentType = response.headers.get('content-type');

                if (contentType?.includes('video')) {
                    log(`‚úÖ Content-Type OK: ${contentType}`, 'success');
                } else {
                    log(`‚ö†Ô∏è Content-Type may not be correct: ${contentType}`, 'warning');
                }
            } catch (error) {
                log(`‚ùå Content-Type test error: ${error.message}`, 'error');
            }
        }

        // Test accept ranges
        async function testAcceptRanges() {
            log('Checking Accept-Ranges support...', 'info');
            const url = getStreamURL();

            try {
                const response = await fetch(url, { method: 'HEAD' });
                const acceptRanges = response.headers.get('accept-ranges');

                if (acceptRanges === 'bytes') {
                    log(`‚úÖ Server supports range requests: ${acceptRanges}`, 'success');
                } else {
                    log(`‚ö†Ô∏è Server may not support range requests: ${acceptRanges}`, 'warning');
                }
            } catch (error) {
                log(`‚ùå Accept-Ranges test error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
